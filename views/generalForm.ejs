<!-- views/profile.ejs -->
<!doctype html>
<html>
<head>
	<title>FAW/Locust Project -  Data Entry</title>
	<meta charset="UTF-8">
	<link rel="stylesheet" href="/css/style_final.css" type="text/css">
	<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css">
	<link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css">
	<link rel="stylesheet" href="//unpkg.com/flatpickr@4.1.1/dist/flatpickr.min.css">
	<style>
		body 		{ padding-top:80px; word-wrap:break-word; }
	</style>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="//unpkg.com/flatpickr@4.1.1/dist/flatpickr.js"></script>
	<!--<script src="/scripts/jquery.form.min.js"></script>-->
	<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
	<script src="//maps.googleapis.com/maps/api/js?key=AIzaSyBX94wEDdQ52lCDhKAhcfR-flIw1NyLTMA"></script>
</head>
<body onload="getLocation()">
<div class="container">

	<div id="modal" class="modal">
		<!-- Modal content -->
		<div id="modal-content">
			<div id="modal-header">
				<span id="close"></span>
				<h2 id="header"></h2>
			</div>
			<div id="modal-body">
				<p id="body"></p>
			</div>
			<div id="modal-footer">
			</div>
		</div>
	</div>

	<h1 id="title">Step 1/2: General Form</h1>
	<div id="container">
		<form id = "uploadForm" method = "post" action = "/generalForm">
            <h4>Transaction ID: &nbsp;&nbsp;&nbsp;</h4><input id="transactionID" name="transactionID" type="text" value="<%= transactionID %>" readonly><br><br>
			<h4>Your Name: &nbsp;&nbsp;&nbsp;</h4><input id="firstName" type="text" value="<%= firstname %>" readonly><input id="lastName" type="text" value="<%= lastname %>" readonly><br><br>
            <h4>Date: &nbsp;&nbsp;&nbsp;</h4><input id="DATE1" name="date" class="date" value=""><br><br>
            <h4>Trap Owner: &nbsp;&nbsp;&nbsp;</h4><input id="trapOwner" name="trapOwner" type="text" placeholder="Enter The Trap Owner's Name"><br><br>
			<h4>Location Name: &nbsp;&nbsp;&nbsp;</h4><input id="locationName" name="locationName" type="text" placeholder="Enter Location Here" required><br><br>
			<h4>Location Type: &nbsp;&nbsp;&nbsp;</h4>
				<select id='locationType' name='locationType' required>
					<option value=''>SELECT THE LOCATION TYPE</option>
					<option value="Location Type"></option>
				</select><br><br>
			<h4 id="GPSLocationTitle">GPS Location: &nbsp;&nbsp;&nbsp;</h4>
			<h4 style="color:red" id="errorMessage"></h4>
			<h5 style="color:#9d9d9d;" id="locationNote"></h5>
			<div id="locationDiv"></div>
			<div id="map"></div><br>
            <h4>Country: &nbsp;&nbsp;&nbsp;</h4>
            <select id='country' name='country' required>
                <option value=''>SELECT THE COUNTRY</option>
                <option value="Country"></option>
            </select><br><br>
            <h4>Province: &nbsp;&nbsp;&nbsp;</h4>
            <select id='province' name='province' required>
                <option value=''>SELECT THE PROVINCE</option>
                <option value="Province"></option>
            </select><br><br>
            <h4>District: &nbsp;&nbsp;&nbsp;</h4>
            <select id='district' name='district' required>
                <option value=''>SELECT THE DISTRICT</option>
                <option value="District"></option>
            </select><br><br>
			<h4>Cropping System: &nbsp;&nbsp;&nbsp;</h4>
			<h4 id="cropSystemTitle">
				<select id='cropSystem' name='croppingSystem' onchange='rotationInterCropSystem();' required>
					<option value=''>SELECT THE CROP SYSTEM</option>
					<option>SEASONAL</option>
					<option>ROTATION</option>
					<option>INTERCROPPING</option>
				</select>
				<h4 id="mainCropTitle"></h4>
			</h4><br>
			<h4>Maize Variety: &nbsp;&nbsp;&nbsp;</h4><input id="maizeVariety" name="maizeVariety" type="text" placeholder="Enter Crop Variety Here" required><br><br>
			<h4>Maize Planting Date: &nbsp;&nbsp;&nbsp;</h4><input id="DATE2" name="plantingDate" class="date" value=""><br><br>
			<h4>Field Size - ha (numerical XXXX.X): &nbsp;&nbsp;&nbsp;</h4>
			<h5 style="color:#9d9d9d;">Note: There is no need to enter the decimals, etc. Please enter the number ONLY.</h5>
			<input id="fieldSizeInteger" name="fieldSizeInteger" type="number" min="0" max="999999" placeholder="0000" onkeyup="limit()" required>.
			<input id="fieldSizeDecimal" name="fieldSizeDecimal" type="number" min="0" max="9" placeholder="0" onkeyup="limit()" required><br><br>
			<h4>General Health of Maize: &nbsp;&nbsp;&nbsp;</h4>
				<select id='healthOfMaize' name='healthOfMaize' required>
					<option value=''>SELECT THE GENERAL HEALTH LEVEL</option>
					<option>POOR</option>
					<option>MEDIUM</option>
					<option>GOOD</option>
				</select><br><br>
			<h4>Date of Last RainFall: &nbsp;&nbsp;&nbsp;</h4><input id="DATE3" name="lastRainDate" class="date" value=""><br><br>
			<h4>Entry Type: &nbsp;&nbsp;&nbsp;</h4>
			<select id='type' name="entryType" required>
				<option value=''>SELECT THE TYPE</option>
				<option>SCOUTING</option>
				<option>TRAP</option>
			</select><br><br>
			<input type="submit" value="CONTINUE">
		</form>
	</div>
</div>
<script>

    $(function(){
        //getLocation();

        flatpickr(".date", {
            dateFormat: "Y-m-d",
            time_24hr: true
        });

        var today = new Date();
        var todayDate = today.getFullYear()+'-'+('0' + (today.getMonth()+1)).slice(-2)+'-'+('0' + today.getDate()).slice(-2);
        var todayDateV = document.getElementsByClassName("date");
        for (var i = 0; i < todayDateV.length; i++) {
            todayDateV[i].value = todayDate;
        }

        $('#uploadForm').submit(function(e) {
            alert("A");
            // Prevent form submission
            e.preventDefault();

            $.ajax({
                type: "post",
                url: $(this).attr("action"),
                dataType: 'json',
                data: $(this).serialize(),
                success: function (result) {
                    if (!result.error) {
                        window.location.replace('/detailedForm')
                    } else {
                        alert (result.message)
                    }
                }
            })
        })
    });


    //Get geolocation and map preview
    function getLocation() {

        $("#locationDiv").append($("<h4 id='latitudeTitle'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Latitude: </h4><h4 id='latitudeStatus'>Locating......</h4><h4 id='longitudeTitle'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Longitude: </h4><h4 id='longitudeStatus'>Locating......</h4>"));

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition, showError);
        } else {
            $("#latitudeStatus").remove();
            $("#longitudeStatus").remove();
            document.getElementById("errorMessage").innerHTML = "ERROR: Geolocation is not supported by this browser."
            alert("Geolocation is not supported by this browser.");

            createInputBox();
        }
    }

    function showPosition(position) {
        $("#latitudeStatus").remove();
        $("#longitudeStatus").remove();

        var uluru = {lat: position.coords.latitude, lng: position.coords.longitude};
        var map = new google.maps.Map(document.getElementById('map'), {
            zoom: 4,
            center: uluru,
            mapTypeId: 'hybrid'
        });

        var marker = new google.maps.Marker({
            position: uluru,
            map: map
        });

        var latiDD = position.coords.latitude;
        var longDD = position.coords.longitude;

        var latiDirection;
        var longDirection;
        // check direction
        if (latiDD >= 0) {
            latiDirection = "N";
        } else if (latiDD < 0) {
            latiDirection = "S";
            latiDD = latiDD * -1;
        }
        if (longDD >= 0) {
            longDirection = "E";
        } else if (longDD < 0) {
            longDirection = "W";
            longDD = longDD * -1;
        }
        // convert latitude from Decimal Degree to Degrees Minutes Seconds
        var latiDegrees = Math.floor(latiDD);
        var latiMinutes = Math.floor((latiDD - latiDegrees) * 60);
        var latiSeconds = ((latiDD - latiDegrees) * 60 - latiMinutes) * 60;
        // convert longitude from Decimal Degree to Degrees Minutes Seconds
        var longDegrees = Math.floor(longDD);
        var longMinutes = Math.floor((longDD - longDegrees) * 60);
        var longSeconds = ((longDD - longDegrees) * 60 - longMinutes) * 60;

        var latitude = latiDirection + " " + latiDegrees + " " + latiMinutes + " " + latiSeconds;
        var longitude = longDirection + " " + longDegrees + " " + longMinutes + " " + longSeconds;

        createInputBox(latitude, longitude);
    }

    function showError(error) {

        var errorMessage = document.getElementById("errorMessage");
        $("#latitudeStatus").remove();
        $("#longitudeStatus").remove();
        switch(error.code) {
            case error.PERMISSION_DENIED:
                errorMessage.innerHTML = "ERROR: User denied the request for Geolocation."
                break;
            case error.POSITION_UNAVAILABLE:
                errorMessage.innerHTML = "ERROR: Location information is unavailable."
                break;
            case error.TIMEOUT:
                errorMessage.innerHTML = "ERROR: The request to get user location timed out."
                break;
            case error.UNKNOWN_ERROR:
                errorMessage.innerHTML = "ERROR: An unknown error occurred."
                break;
        }
        createInputBox();
    }

    function createInputBox(lati, long) {
        // [0] = direction; [1] = degrees; [2] = minutes; [3] = seconds
        var latitude = [];
        var longitude = [];
        if (lati && long) {
            document.getElementById("locationNote").innerHTML = "Note: Please Verify Latitude/Longitude and Change if is Incorrect !";
            latitude = lati.split(" ");
            longitude = long.split(" ");
        } else {
            document.getElementById("locationNote").innerHTML = "Note: Please Manually Enter Latitude/Longitude !";
        }

        var latitudeTitle = $("#latitudeTitle");
        var latitudeSelect = $("<select id='latitudeDirection' name='latitudeDirection' required>");
        latitudeTitle.append(latitudeSelect);
        if (latitude[0] === "N" || !latitude[0]) {
            latitudeSelect.append($("<option>N</option><option>S</option>"));
        } else if (latitude[0] === "S") {
            latitudeSelect.append($("<option>S</option><option>N</option>"));
        }
        latitudeTitle.append($("</select>"));

        var longitudeTitle = $("#longitudeTitle");
        var longitudeSelect = $("<select id='longitudeDirection' name='longitudeDirection' required>");
        longitudeTitle.append(longitudeSelect);
        if (longitude[0] === "E" || !longitude[0]) {
            longitudeSelect.append($("<option>E</option><option>W</option>"));
        } else if (longitude[0] === "W") {
            longitudeSelect.append($("<option>W</option><option>E</option>"));
        }
        longitudeTitle.append($("</select>"));

        latitudeTitle.append($("<input id='latitudeDegree' name='latitudeDegree' type='number' value='" + latitude[1] + "' required>°" + " <input id='latitudeMinute' name='latitudeMinute' type='number' value='" + latitude[2] + "' required>'" + " <input id='latitudeSecond' name='latitudeSecond' type='number' value='" + Math.round(latitude[3] * 1000) / 1000 + "' required>''" + "<p></p>"));
        longitudeTitle.append($("<input id='longitudeDegree' name='longitudeDegree' type='number' value='" + longitude[1] + "' required>°" + " <input id='longitudeMinute' name='longitudeMinute' type='number' value='" + longitude[2] + "' required>'" + " <input id='longitudeSecond' name='longitudeSecond' type='number' value='" + Math.round(longitude[3] * 1000) / 1000 + "' required>''" + "<p></p>"));

        $("#locationDiv").append($("<input type='button' onclick='refresh()' value='Click here to refresh the map'>"));
    }

    function refresh() {
        var latiDirection = document.getElementById("latitudeDirection").value;
        var longDirection = document.getElementById("longitudeDirection").value;
        var latiDegree = document.getElementById("latitudeDegree").value;
        var longDegree = document.getElementById("longitudeDegree").value;
        var latiMinute = document.getElementById("latitudeMinute").value;
        var longMinute = document.getElementById("longitudeMinute").value;
        var latiSecond = document.getElementById("latitudeSecond").value;
        var longSecond = document.getElementById("longitudeSecond").value;

        if (latiDirection && longDirection && latiDegree && longDegree && latiMinute && longMinute && latiSecond && longSecond) {
            // convert latitude & longitude from Degrees Minutes Seconds to Decimal Degree
            var latiDD = parseFloat(latiDegree) + (parseFloat(latiMinute) / 60) + (parseFloat(latiSecond) / 3600);
            var longDD = parseFloat(longDegree) + (parseFloat(longMinute) / 60) + (parseFloat(longSecond) / 3600);
            // change to negative if S or W
            if (latiDirection === "S") {
                latiDD = latiDD * -1;
            }
            if (longDirection === "W") {
                longDD = longDD * -1;
            }

            var newPosition = {lat: latiDD, lng: longDD};
            document.getElementById("map").innerHTML = "";
            var map = new google.maps.Map(document.getElementById('map'), {
                zoom: 4,
                center:  newPosition,
                mapTypeId: 'hybrid'
            });

            var marker = new google.maps.Marker({
                position:  newPosition,
                map: map
            });
        } else {

        }
    }

    function rotationInterCropSystem() {
        $("#mainCrop").remove();
        $("#otherMainCrop").remove();
        if (document.getElementById("cropSystem").value !== "SEASONAL" || document.getElementById("cropSystem").value === "") {
            var mainCropList = ["MAIZE", "RICE", "SORGHUM", "VEGETABLES", "OTHER"];
            var mainCropTitle = $("#mainCropTitle");
            var mainCropSelect = $("<select id='mainCrop' name='rota_inter_crop' onchange='otherMainCrop()' required>");
            mainCropTitle.append(mainCropSelect);
            mainCropSelect.append($("<option value=''>SELECT THE MAIN CROP</option>"));
            for (var i = 0; i < mainCropList.length; i++) {
                var mainCropOption = $("<option>" + mainCropList[i] + "</option>");
                mainCropSelect.append(mainCropOption);
            }
            mainCropTitle.append($("</select>"));
        }
    }

    function otherMainCrop() {
        if (document.getElementById("mainCrop").value === "OTHER") {
            var mainCropTitle = $("#mainCropTitle");
            mainCropTitle.append($("<input id='otherMainCrop' name='otherMainCrop' type='text' placeholder=\"ENTER THE MAIN CROP\" required>"));
        } else {
            $("#otherMainCrop").remove();
        }
    }

    function limit() {
        var key = event.which || event.keyCode;
        var activeElementId = document.activeElement.id;
        if (activeElementId === "fieldSizeInteger") {
            var four_digit = document.getElementById("fieldSizeInteger").value;

            if (key === 190) {
                //alert(document.getElementById("fieldSizeInteger").value);
                document.getElementById("fieldSizeInteger").value = four_digit + "00000";

                document.getElementById("fieldSizeDecimal").focus();
            }

            if (document.getElementById("fieldSizeInteger").value.length > 4) {
                //alert(four_digit + " " + four_digit.length);

                document.getElementById("fieldSizeInteger").value = four_digit.substring(0, 4);
            }
        } else if (activeElementId === "fieldSizeDecimal") {
            var one_digit = document.getElementById("fieldSizeDecimal").value;

            if (one_digit.length > 1) {
                document.getElementById("fieldSizeDecimal").value = one_digit.substring(0, 1);
            }
        }
    }

//    var formData = $('#uploadForm').serialize();
//    function Continue() {
//        $.ajax({
//            type: "post",
//            url: "/generalForm",
//            dataType: 'json',
//            data: formData,
//            success: function(result) {
//                alert("success!");
//            }
//        })


</script>
</body>
</html>
